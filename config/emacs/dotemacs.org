#+TITLE: heymatthenry's emacs config
#+AUTHOR: matt henry
#+STARTUP: showeverything
#+OPTIONS: toc:2

* Contents :TOC:
- [[#mission-critical][Mission critical]]
  - [[#load-elpaca-for-package-management][Load elpaca for package management]]
  - [[#configure-elpaca-to-use-use-package][Configure elpaca to use ~use-package~]]
  - [[#evil-][Evil ðŸ¤˜]]
  - [[#vcs][VCS]]
- [[#ui-][UI ðŸ’…]]
  - [[#fonts][Fonts]]
  - [[#theme][Theme]]
  - [[#pretty-icons][Pretty icons]]
  - [[#file-drawer][File drawer]]
  - [[#modeline][Modeline]]
  - [[#remove-ui-cruft][Remove UI cruft]]
- [[#put-the-mac-in-emacs][Put the Mac in emacs]]
- [[#keybindings][Keybindings]]
  - [[#which-key][Which-Key]]
  - [[#general][General]]
  - [[#vanilla-keybinds][Vanilla keybinds]]
- [[#snippets-and-autocomplete][Snippets and autocomplete]]
- [[#projectile][Projectile]]
- [[#ide-features][IDE Features]]
  - [[#language-configuration][Language configuration]]
  - [[#treesitter][Treesitter]]
  - [[#lsp][LSP]]
  - [[#configure-formatters-eslint-etc][Configure formatters (eslint, etc.)]]
  - [[#add-emmet][Add emmet]]
- [[#org-mode][Org Mode]]
  - [[#directory-setup][Directory setup]]
  - [[#appearance][Appearance]]
- [[#terminal-support][Terminal support]]

* Mission critical

** Load elpaca for package management

This comes directly from [[https://github.com/progfolio/elpaca][Elpaca's github repo]]

#+begin_src emacs-lisp
  (defvar elpaca-installer-version 0.4)
  (defvar elpaca-directory (expand-file-name "elpaca/" user-emacs-directory))
  (defvar elpaca-builds-directory (expand-file-name "builds/" elpaca-directory))
  (defvar elpaca-repos-directory (expand-file-name "repos/" elpaca-directory))
  (defvar elpaca-order '(elpaca :repo "https://github.com/progfolio/elpaca.git"
				 :ref nil
				 :files (:defaults (:exclude "extensions"))
				 :build (:not elpaca--activate-package)))
  (let* ((repo  (expand-file-name "elpaca/" elpaca-repos-directory))
	  (build (expand-file-name "elpaca/" elpaca-builds-directory))
	  (order (cdr elpaca-order))
	  (default-directory repo))
    (add-to-list 'load-path (if (file-exists-p build) build repo))
    (unless (file-exists-p repo)
      (make-directory repo t)
      (when (< emacs-major-version 28) (require 'subr-x))
      (condition-case-unless-debug err
	   (if-let ((buffer (pop-to-buffer-same-window "*elpaca-bootstrap*"))
		    ((zerop (call-process "git" nil buffer t "clone"
					  (plist-get order :repo) repo)))
		    ((zerop (call-process "git" nil buffer t "checkout"
					  (or (plist-get order :ref) "--"))))
		    (emacs (concat invocation-directory invocation-name))
		    ((zerop (call-process emacs nil buffer nil "-Q" "-L" "." "--batch"
					  "--eval" "(byte-recompile-directory \".\" 0 'force)")))
		    ((require 'elpaca))
		    ((elpaca-generate-autoloads "elpaca" repo)))
	       (kill-buffer buffer)
	     (error "%s" (with-current-buffer buffer (buffer-string))))
	 ((error) (warn "%s" err) (delete-directory repo 'recursive))))
    (unless (require 'elpaca-autoloads nil t)
      (require 'elpaca)
      (elpaca-generate-autoloads "elpaca" repo)
      (load "./elpaca-autoloads")))
  (add-hook 'after-init-hook #'elpaca-process-queues)
  (elpaca `(,@elpaca-order))
#+end_src

** Configure elpaca to use ~use-package~

#+begin_src emacs-lisp
  ;; Install use-package support
(elpaca elpaca-use-package
  ;; Enable :elpaca use-package keyword.
  (elpaca-use-package-mode)
  ;; Assume :elpaca t unless otherwise specified.
  (setq elpaca-use-package-by-default t))

;; Block until current queue processed.
(elpaca-wait)
#+end_src

#+begin_src emacs-lisp
  (use-package exec-path-from-shell
    :config
    (exec-path-from-shell-initialize))
#+end_src

** Evil ðŸ¤˜

#+begin_src emacs-lisp
  (use-package evil
    :init      ;; tweak evil's configuration before loading it
    (setq evil-want-integration t) ;; This is optional since it's already set to t by default.
    (setq evil-want-keybinding nil)
    (setq evil-vsplit-window-right t)
    (setq evil-split-window-below t)
    (setq evil-want-minibuffer t)

    (with-eval-after-load 'evil-maps
      (define-key evil-normal-state-map (kbd "<remap> <evil-next-line>") 'evil-next-visual-line)
      (define-key evil-normal-state-map (kbd "<remap> <evil-previous-line>") 'evil-previous-visual-line)
      (define-key evil-motion-state-map (kbd "<remap> <evil-next-line>") 'evil-next-visual-line)
      (define-key evil-motion-state-map (kbd "<remap> <evil-previous-line>") 'evil-previous-visual-line)

      (define-key evil-normal-state-map "P" 'counsel-yank-pop))

    (evil-mode))

  (use-package evil-collection
    :after evil
    :config
    (evil-collection-init))
  (use-package evil-tutor)
#+end_src

#+begin_src emacs-lisp
(use-package evil-surround
  :ensure t
  :config
  (global-evil-surround-mode 1))
#+end_src

** VCS

Doom-style gitgutter config, cribbed entirely from [[https://ianyepan.github.io/posts/emacs-git-gutter/][this blog post]]

#+begin_src emacs-lisp
  (use-package magit)
#+end_src

#+begin_src emacs-lisp
  (use-package git-gutter
      :hook (prog-mode . git-gutter-mode)
      :config
      (setq git-gutter:update-interval 0.02))

  (use-package git-gutter-fringe
      :config
      (define-fringe-bitmap 'git-gutter-fr:added [224] nil nil '(center repeated))
      (define-fringe-bitmap 'git-gutter-fr:modified [224] nil nil '(center repeated))
      (define-fringe-bitmap 'git-gutter-fr:deleted [128 192 224 240] nil nil 'bottom))
#+end_src

* UI ðŸ’…

** Fonts

#+begin_src emacs-lisp
  (set-face-attribute 'default nil
      :font "JuliaMono"
      :height 140
      :weight 'medium)

  (set-face-attribute 'variable-pitch nil
      :font "Source Sans Pro"
      :height 160
      :weight 'medium)

  (set-face-attribute 'fixed-pitch nil
      :font "JuliaMono"
      :height 140
      :weight 'medium)
#+end_src

** Theme

#+begin_src emacs-lisp
  (use-package doom-themes
    :ensure t
    :config
    ;; Global settings (defaults)
    (setq doom-themes-enable-bold t    ; if nil, bold is universally disabled
	  doom-themes-enable-italic t) ; if nil, italics is universally disabled
    (load-theme 'doom-one t)

    ;; Enable flashing mode-line on errors
    (doom-themes-visual-bell-config)
    ;; Enable custom neotree theme (all-the-icons must be installed!)
    (doom-themes-neotree-config)
    ;; or for treemacs users
    (setq doom-themes-treemacs-theme "doom-atom") ; use "doom-colors" for less minimal icon theme
    (doom-themes-treemacs-config)
    ;; Corrects (and improves) org-mode's native fontification.
    (doom-themes-org-config))
#+end_src

** Pretty icons

#+begin_src emacs-lisp
(use-package all-the-icons
  :if (display-graphic-p))
#+end_src

** File drawer

#+begin_src emacs-lisp
  (use-package treemacs
    :ensure t
    :defer t
    :config
    (progn
      (setq treemacs-position 'right)))

  (use-package treemacs-evil
    :after (treemacs evil))

  (use-package treemacs-projectile
    :after (treemacs projectile)
    :ensure t)

  (use-package treemacs-icons-dired
    :hook (dired-mode . treemacs-icons-dired-enable-once))

  (use-package treemacs-magit
    :after (treemacs magit))
#+end_src

** Modeline

#+begin_src emacs-lisp
  (use-package doom-modeline
    :ensure t
    :init (doom-modeline-mode 1))
#+end_src

** Remove UI cruft

#+begin_src emacs-lisp
  (menu-bar-mode -1)
  (tool-bar-mode -1)
  (scroll-bar-mode -1)
#+end_src

* Put the Mac in emacs

#+begin_src emacs-lisp
  (setq mac-option-key-is-meta nil)
  (setq mac-command-key-is-meta t)
  (setq mac-command-modifier 'meta)
  (setq mac-option-modifier nil)
#+end_src

* Keybindings

** Which-Key

#+begin_src emacs-lisp
  (use-package which-key
    :config
    (which-key-mode))
#+end_src

** General

#+begin_src emacs-lisp
    (defun find-in-config-dir ()
      (interactive)
      (find-file user-emacs-directory))

    (defun reload-user-config ()
      (interactive)
      (load-file user-init-file)
      (load-file user-init-file))

    (use-package general
      :config
      (general-evil-setup)

      ;; set up 'SPC' as the global leader key
      (general-create-definer mh/leader-keys
	:states '(normal insert visual emacs)
	:keymaps 'override
	:prefix "SPC" ;; set leader
	:global-prefix "M-SPC") ;; access leader in insert mode

      (mh/leader-keys
	"b" '(:ignore t :wk "buffer")
	"bb" '(switch-to-buffer :wk "Switch buffer")
	"bd" '(kill-this-buffer :wk "Kill this buffer")
	"bn" '(next-buffer :wk "Next buffer")
	"bp" '(previous-buffer :wk "Previous buffer")
	"br" '(revert-buffer :wk "Reload buffer")

	"f" '(:ignore t :wk "find")
	"ff" '(find-file :wk "Find file")
	"fj" '(counsel-file-jump :wk "Find file recursively")
	"fp" '(find-in-config-dir :wk "Open personal config")
	"fc" '(reload-user-config :wk "Reload personal config")
	"fr" '(counsel-recentf :wk "Find recent files")
	"fg" '(counsel-rg :wk "Search for text (ripgrep)")

	"g" '(:ignore t :wk "git")
	"gg" '(magit-status :wk "Magit status")
	"gn" '(git-gutter:next-hunk :wk "Next hunk")
	"gp" '(git-gutter:previous-hunk :wk "Previous hunk")
	"gh" '(:ignore t :wk "git hunk")
	"ghs" '(git-gutter:stage-hunk :wk "Stage hunk")
	"ghr" '(git-gutter:revert-hunk :wk "Revert hunk")

	"o" '(:ignore o :wk "Org mode")
	"oo" '((lambda () (interactive) (find-file "~/org/notes.org")) :wk "Org mode")
	"ot" '(org-todo :wk "Change todo item state")

	"p" '(:ignore t :wk "projectile")
	"pp" '(projectile-switch-project :wk "Switch to project")
	"pf" '(projectile-find-file :wk "Find file in project")
	"pt" '(treemacs :wk "Open project drawer")

	"t" '(:ignore t :wk "terminal")
	"tt" '(multi-vterm-dedicated-toggle :wk "Toggle terminal")
	"tn" '(multi-vterm :wk "New terminal")
	)

      (mh/leader-keys
	'normal org-mode-map
	"te" '(toggle-emphasis-markers :wk "Toggle display of emphasis markers"))

      (general-define-key
	 "M-C-f" 'toggle-frame-fullscreen)
  )
#+end_src

#+begin_src emacs-lisp
(with-eval-after-load 'evil-maps
  (define-key evil-motion-state-map (kbd "SPC") nil)
  (define-key evil-motion-state-map (kbd "RET") nil)
  (define-key evil-motion-state-map (kbd "TAB") nil))
#+end_src 

** Vanilla keybinds

#+begin_src emacs-lisp
  (global-set-key (kbd "C-c h")  'windmove-left)
  (global-set-key (kbd "C-c l") 'windmove-right)
  (global-set-key (kbd "C-c k")    'windmove-up)
  (global-set-key (kbd "C-c j")  'windmove-down)

  (global-set-key (kbd "C-`") 'multi-vterm-dedicated-toggle)
  (global-set-key (kbd "C-<tab>") 'treemacs)
#+end_src

* Snippets and autocomplete

- Ivy is a completion framework
- counsel wraps emacs commands in Ivy goodness
- ivy-rich enables rich descriptions of commands in the minibuffer

#+begin_src emacs-lisp
(use-package counsel
  :after ivy
  :config (counsel-mode))

(use-package ivy
  :bind
  ;; ivy-resume resumes the last Ivy-based completion.
  (("C-c C-r" . ivy-resume)
   ("C-x B" . ivy-switch-buffer-other-window))
  :custom
  (setq ivy-use-virtual-buffers t)
  (setq ivy-count-format "(%d/%d) ")
  (setq enable-recursive-minibuffers t)
  :config
  (ivy-mode))

(use-package all-the-icons-ivy-rich
  :ensure t
  :init (all-the-icons-ivy-rich-mode 1))

(use-package ivy-rich
  :after ivy
  :ensure t
  :init (ivy-rich-mode 1) ;; this gets us descriptions in M-x.
  :custom
  (ivy-virtual-abbreviate 'full
   ivy-rich-switch-buffer-align-virtual-buffer t
   ivy-rich-path-style 'abbrev)
  :config
  (ivy-set-display-transformer 'ivy-switch-buffer
                               'ivy-switch-buffer-transformer))
#+end_src


* Projectile

#+begin_src emacs-lisp
  (use-package projectile
    :config
    (projectile-mode +1))
#+end_src

* IDE Features

** Language configuration

#+begin_src emacs-lisp
  (use-package web-mode)
  (add-to-list 'auto-mode-alist '("\\.html?\\'" . web-mode))

  (use-package typescript-mode
    :ensure t
    :hook (typescript-mode . lsp-deferred)
    :config
      (setq typescript-indent-level 2))


  (use-package rust-mode
    :config
      (setq rust-indent-level 2))
#+end_src

** Treesitter

#+begin_src emacs-lisp
  (use-package tree-sitter-langs)
  (use-package tree-sitter
    :init
    (global-tree-sitter-mode)
    (add-hook 'tree-sitter-after-on-hook #'tree-sitter-hl-mode))
#+end_src

** LSP

#+begin_src emacs-lisp
 (use-package flycheck
    :ensure t
    :init (global-flycheck-mode)) 
#+end_src

#+begin_src emacs-lisp
    (use-package lsp-mode
      :init
      :hook ((python-mode . lsp)
	     (web-mode . lsp)
	     (js-mode . lsp)
	     (js-jsx-mode . lsp)
	     (javascript-mode . lsp)
	     (typescript-mode . lsp)
	     (rust-mode . lsp)
	     (css-mode . lsp)
	     (scss-mode . lsp)

	     (lsp-mode . lsp-enable-which-key-integration))
      :commands lsp)

    (use-package lsp-ui
      :commands lsp-ui-mode
      :hook (lsp-mode . lsp-ui-mode))

    (use-package lsp-treemacs :commands lsp-treemacs-errors-list)
    (use-package lsp-ivy)
#+end_src

#+begin_src emacs-lisp
    (use-package rust-mode
      :config
      (setq rust-format-on-save t)
      (add-hook 'rust-mode-hook
		(lambda () (prettify-symbols-mode))))
#+end_src

** TODO Configure formatters (eslint, etc.)

#+begin_src emacs-lisp
  (use-package format-all
    :config
    (add-hook 'prog-mode-hook 'format-all-mode)
    (add-hook 'format-all-mode-hook 'format-all-ensure-formatter))
#+end_src

** TODO Add emmet


* Org Mode

** Directory setup

#+begin_src emacs-lisp
  (setq org-directory "~/org")
  (setq org-agenda-files (list org-directory))
  (setq org-default-notes-file (concat org-directory "/notes.org"))
 #+end_src

  #+begin_src emacs-lisp
  (setq org-return-follows-link t)
#+end_src

#+begin_src emacs-lisp
(electric-indent-mode -1)
#+end_src

** Appearance

*** Hide emphasis markers

This is just a utility function to toggle empasis markers. It can be nice to look at an org file with the markers hidden, but also kind of a pain to edit them.
Hide /emphasis/ *markers*. Or =verbatim=. ~Code~. Or +forget the whole thing+

#+begin_src emacs-lisp
  (defun toggle-emphasis-markers ()
    (interactive)
    (setq org-hide-emphasis-markers (not org-hide-emphasis-markers))
    (font-lock-update))
#+end_src

*** Enable TOC 

#+begin_src emacs-lisp
(use-package toc-org
    :commands toc-org-enable
    :init (add-hook 'org-mode-hook 'toc-org-enable)) 
#+end_src

*** Add ~org-modern~ and associated styles

#+begin_src emacs-lisp
  (use-package org-modern
    :config
    (global-org-modern-mode))

  (setq
   ;; Edit settings
   org-auto-align-tags nil
   org-tags-column 0
   org-catch-invisible-edits 'show-and-error
   org-special-ctrl-a/e t
   org-insert-heading-respect-content t

   ;; Org styling, hide markup etc.
   org-hide-emphasis-markers t
   org-pretty-entities t
   org-ellipsis "â€¦"

   ;; Agenda styling
   org-agenda-tags-column 0
   org-agenda-block-separator ?â”€
   org-agenda-time-grid
   '((daily today require-timed)
     (800 1000 1200 1400 1600 1800 2000)
     " â”„â”„â”„â”„â”„ " "â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„")
   org-agenda-current-time-string
   "â­  now â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")

#+end_src

#+begin_src emacs-lisp
  (global-display-line-numbers-mode 1)
  (global-visual-line-mode t)
  
  (add-hook 'treemacs-mode-hook (lambda() (display-line-numbers-mode -1)))
  (add-hook 'org-mode-hook (lambda() (display-line-numbers-mode -1)))
#+end_src

#+begin_src emacs-lisp
  (require 'server)
    (or (server-running-p)
  (server-start))
  (require 'org-protocol)
#+end_src

* Terminal support

If one of the supposed benefits of emacs is that I don't have to context-switch out of it for most things, I'm going to need some way of easily working with terminals. I haven't loved the built-in options for doing that so I'll try vterm.

#+begin_src emacs-lisp
  (use-package vterm)

  (use-package multi-vterm

	  :config
	  (add-hook 'vterm-mode-hook
			  (lambda ()
			  (setq-local evil-insert-state-cursor 'box)
			  (evil-insert-state)))
	  (define-key vterm-mode-map [return]                      #'vterm-send-return)

	  (setq vterm-keymap-exceptions nil)
	  (evil-define-key 'insert vterm-mode-map (kbd "C-e")      #'vterm--self-insert)
	  (evil-define-key 'insert vterm-mode-map (kbd "C-f")      #'vterm--self-insert)
	  (evil-define-key 'insert vterm-mode-map (kbd "C-a")      #'vterm--self-insert)
	  (evil-define-key 'insert vterm-mode-map (kbd "C-v")      #'vterm--self-insert)
	  (evil-define-key 'insert vterm-mode-map (kbd "C-b")      #'vterm--self-insert)
	  (evil-define-key 'insert vterm-mode-map (kbd "C-w")      #'vterm--self-insert)
	  (evil-define-key 'insert vterm-mode-map (kbd "C-u")      #'vterm--self-insert)
	  (evil-define-key 'insert vterm-mode-map (kbd "C-d")      #'vterm--self-insert)
	  (evil-define-key 'insert vterm-mode-map (kbd "C-n")      #'vterm--self-insert)
	  (evil-define-key 'insert vterm-mode-map (kbd "C-m")      #'vterm--self-insert)
	  (evil-define-key 'insert vterm-mode-map (kbd "C-p")      #'vterm--self-insert)
	  (evil-define-key 'insert vterm-mode-map (kbd "C-j")      #'vterm--self-insert)
	  (evil-define-key 'insert vterm-mode-map (kbd "C-k")      #'vterm--self-insert)
	  (evil-define-key 'insert vterm-mode-map (kbd "C-r")      #'vterm--self-insert)
	  (evil-define-key 'insert vterm-mode-map (kbd "C-t")      #'vterm--self-insert)
	  (evil-define-key 'insert vterm-mode-map (kbd "C-g")      #'vterm--self-insert)
	  (evil-define-key 'insert vterm-mode-map (kbd "C-c")      #'vterm--self-insert)
	  (evil-define-key 'insert vterm-mode-map (kbd "C-SPC")    #'vterm--self-insert)
	  (evil-define-key 'normal vterm-mode-map (kbd "C-d")      #'vterm--self-insert)
	  (evil-define-key 'normal vterm-mode-map (kbd ",c")       #'multi-vterm)
	  (evil-define-key 'normal vterm-mode-map (kbd ",n")       #'multi-vterm-next)
	  (evil-define-key 'normal vterm-mode-map (kbd ",p")       #'multi-vterm-prev)
	  (evil-define-key 'normal vterm-mode-map (kbd "i")        #'evil-insert-resume)
	  (evil-define-key 'normal vterm-mode-map (kbd "o")        #'evil-insert-resume)
	  (evil-define-key 'normal vterm-mode-map (kbd "<return>") #'evil-insert-resume))

#+end_src
